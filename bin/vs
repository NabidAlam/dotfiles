#!/usr/bin/env bash

find_sln() {
    local basedir=$1

    local matches=$(ls -1 $basedir/*.sln)

    if [ -z $matches ]; then
        echo "error: No solution file found" 1>&2
        exit 1
    else
        local match_count=$(echo $matches | wc -l | awk '{print $1}')

        if [[ $match_count == "1" ]]; then
            echo $matches
        else
            echo "error: Multiple solutions found (TODO: Allow selecting one)" 1>&2
            exit 1
        fi
    fi
}

if [ "$(uname)" = "Darwin" ]; then
    sln=$(find_sln $(pwd))
    echo "Launching solution: $sln"
    open $sln
elif [ "$WSL" = "1" ]; then
    # Launch PowerShell in this directory and run "Invoke-VisualStudio" from that
    # Encoded command is:
    #  { Import-Module $env:USERPROFILE\.dotfiles\powershell\modules\ps-cmdinterop\PS-CmdInterop.psd1; Import-Module $env:USERPROFILE\.dotfiles\powershell\modules\ps-vsvars\PS-VsVars.psd1; Invoke-VisualStudio }
    powershell.exe -NoProfile -NoLogo -OutputFormat Text -EncodedCommand "IABJAG0AcABvAHIAdAAtAE0AbwBkAHUAbABlACAAJABlAG4AdgA6AFUAUwBFAFIAUABSAE8ARgBJAEwARQBcAC4AZABvAHQAZgBpAGwAZQBzAFwAcABvAHcAZQByAHMAaABlAGwAbABcAG0AbwBkAHUAbABlAHMAXABwAHMALQBjAG0AZABpAG4AdABlAHIAbwBwAFwAUABTAC0AQwBtAGQASQBuAHQAZQByAG8AcAAuAHAAcwBkADEAOwAgAEkAbQBwAG8AcgB0AC0ATQBvAGQAdQBsAGUAIAAkAGUAbgB2ADoAVQBTAEUAUgBQAFIATwBGAEkATABFAFwALgBkAG8AdABmAGkAbABlAHMAXABwAG8AdwBlAHIAcwBoAGUAbABsAFwAbQBvAGQAdQBsAGUAcwBcAHAAcwAtAHYAcwB2AGEAcgBzAFwAUABTAC0AVgBzAFYAYQByAHMALgBwAHMAZAAxADsAIABJAG4AdgBvAGsAZQAtAFYAaQBzAHUAYQBsAFMAdAB1AGQAaQBvACAA" >/dev/null 2>/dev/null
    exit 1
else
    echo "Can't launch VS on Linux\!" 1>&2
    exit 1
fi
